service: stock-prediction-api

provider:
  name: aws
  runtime: python3.10
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  timeout: 300
  memorySize: 3008

  environment:
    PREDICTIONS_TABLE: ${self:service}-predictions-${self:provider.stage}
    STOCK_DATA_TABLE: ${self:service}-stock-data-${self:provider.stage}
    CONNECTIONS_TABLE: ${self:service}-connections-${self:provider.stage}
    ALPHAS_TABLE: ${self:service}-alphas-${self:provider.stage}
    MODELS_BUCKET: ${self:service}-models-${self:provider.stage}
    GROQ_API_KEY: ${ssm:/stock-platform/groq-key~true}
    PREDICTION_LAMBDA_ARN:
      Fn::GetAtt:
        - PredictionsLambdaFunction
        - Arn
    TRAINING_LAMBDA_ARN:
      Fn::GetAtt:
        - TrainingLambdaFunction
        - Arn

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:*
          Resource:
            - Fn::Join:
              - ''
              - - 'arn:aws:s3:::'
                - Ref: ModelsBucket
                - '/*'
            - Fn::Join:
              - ''
              - - 'arn:aws:s3:::'
                - Ref: ModelsBucket
        - Effect: Allow
          Action:
            - dynamodb:*
          Resource:
            - Fn::GetAtt: [PredictionsTable, Arn]
            - Fn::GetAtt: [StockDataTable, Arn]
            - Fn::GetAtt: [ConnectionsTable, Arn]
            - Fn::GetAtt: [AlphasTable, Arn]
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - Fn::GetAtt: [PredictionsLambdaFunction, Arn]
            - Fn::GetAtt: [TrainingLambdaFunction, Arn]
        - Effect: Allow
          Action:
            - ssm:GetParameter
          Resource:
            - Fn::Sub: 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/stock-platform/*'

package:
  individually: true
  patterns:
    - '!.git/**'
    - '!.venv/**'
    - '!node_modules/**'
    - '!__pycache__/**'
    - '!*.pyc'
    - '!test_*.py'
    - '!venv/**'

functions:
  orchestrator:
    handler: lambda-functions/orchestrator/handler.lambda_handler
    timeout: 30
    memorySize: 512
    events:
      - http:
          path: predict
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
    package:
      patterns:
        - 'lambda-functions/orchestrator/**'
        - 'utils/**'
        - '!utils/__pycache__/**'

  predictions:
    handler: lambda-functions/predictions/handler.lambda_handler
    timeout: 60
    memorySize: 3008
    environment:
      PYTORCH_CUDA_ALLOC_CONF: max_split_size_mb:512
    package:
      patterns:
        - 'lambda-functions/predictions/**'
        - 'utils/**'
        - '!utils/__pycache__/**'

  training:
    handler: lambda-functions/training/handler.lambda_handler
    timeout: 900  # 15 minutes for training
    memorySize: 10240  # 10GB for model training
    ephemeralStorageSize: 10240  # 10GB temp storage
    environment:
      PYTORCH_CUDA_ALLOC_CONF: max_split_size_mb:512
    package:
      patterns:
        - 'lambda-functions/training/**'
        - 'utils/**'
        - '!utils/__pycache__/**'

  fetchData:
    handler: lambda-functions/data-fetch/handler.lambda_handler
    timeout: 300
    memorySize: 1024
    events:
      - schedule:
          rate: rate(1 hour)
          enabled: false  # Start disabled
    package:
      patterns:
        - 'lambda-functions/data-fetch/**'
        - 'utils/**'

  websocketConnect:
    handler: lambda-functions/websocket/handler.connect_handler
    events:
      - websocket:
          route: $connect
    package:
      patterns:
        - 'lambda-functions/websocket/**'

  websocketDisconnect:
    handler: lambda-functions/websocket/handler.disconnect_handler
    events:
      - websocket:
          route: $disconnect
    package:
      patterns:
        - 'lambda-functions/websocket/**'

resources:
  Resources:
    PredictionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.PREDICTIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: ticker
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: ticker
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE
        TimeToLiveSpecification:
          Enabled: true
          AttributeName: ttl

    StockDataTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.STOCK_DATA_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: ticker
            AttributeType: S
          - AttributeName: date
            AttributeType: S
        KeySchema:
          - AttributeName: ticker
            KeyType: HASH
          - AttributeName: date
            KeyType: RANGE

    ConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.CONNECTIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        TimeToLiveSpecification:
          Enabled: true
          AttributeName: ttl

    AlphasTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ALPHAS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: ticker
            AttributeType: S
        KeySchema:
          - AttributeName: ticker
            KeyType: HASH

    ModelsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.MODELS_BUCKET}
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldVersions
              Status: Enabled
              NoncurrentVersionExpirationInDays: 30

plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    dockerizePip: true
    dockerImage: public.ecr.aws/sam/build-python3.10:latest
    zip: true
    slim: true
    strip: false
    layer: true
    useStaticCache: false
    useDownloadCache: false
    pipCmdExtraArgs:
      - --platform manylinux2014_x86_64
      - --only-binary=:all:
    noDeploy:
      - boto3
      - botocore
      - docutils
      - jmespath
      - pip
      - python-dateutil
      - s3transfer
      - setuptools
      - six
      - urllib3